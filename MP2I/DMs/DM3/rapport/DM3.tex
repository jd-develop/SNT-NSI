\input{Latex.Settings.tex}

\title{DM3: Conception et utilisation d’un SAT-solver}
\author{}
\date{}

\begin{document}

\maketitle
\section{Conception du SAT-solver}
\subsection*{Q10.}
Soit $n$ le nombre d'opérateurs.

Dans la configuration $(...((a_0 | a_1) | a_2) | ...) | a_n$,
il y a bien $n$ opérateurs.

De plus, la complexité de l'algorithme dans cette configuration est
\begin{align*}
    C_n &= C_{n-1} + C_0 + \Theta(n)\\
    &\geq C_{n-1} + nA\\
    &\geq C_0 + \sum_{i=0}^{n-1}(n-i)A\\
    C_n &= \boxed{\Omega(n^2)}\\
\end{align*}
Donc dans le pire cas, la complexité est au moins de l’ordre de $\Omega(n^2)$.

Pour améliorer la fonction, il faut passer par une variable intermédiaire puis
trier la liste.

\subsection*{Q11. (Bonus)}
Dans la nouvelle fonction, on a
\begin{align*}
    C_n &= \Theta(n) + \Theta(n\log(n))\\
    C_n &= \boxed{\Theta(n\log(n))}\\
\end{align*}

\subsection*{Q19.}
La complexité de l’algorithme dans la configuration $\sim(...(\sim T)...)$ est
\begin{align*}
    C_n &= C_{n-2} + \Theta(n)\\
    C_n &= \boxed{\Theta(n^2)}\\
\end{align*}

\subsection*{Q20. (Bonus)}
Dans la nouvelle fonction, on simplifie les enfants avant le nœud.

La complexité est
\begin{align*}
    C_n &= C_{i} + C_{n-1-i} + \Theta(1), \quad i \in [\![0,n-1]\!]\\
    C_n &= \boxed{\Theta(n)}\\
\end{align*}

\subsection*{Q25.}~

\subsection*{Q26. (Bonus)}
Le satsolver spécialisé en FNC a été implémenté dans \verb|fnc_solver.ml|.
De plus, la propagation unitaire a été rajoutée.

En termes d'efficacité, le satsolver en FNC est meilleur que le simple.
En effet, dans la résolution du problème à $n$ dames (cf. seconde partie),
le satsolver en FNC permet de résoudre plus de dames et en moins de temps.

\section{Résolution de problèmes}
\subsection*{Q31.}
La formule
$\boxed{\bigwedge\limits_{1 \leq i < j \leq n}\left(\lnot a_i \lor \lnot a_j\right)}$
est sous FNC.

Pour $n$ variables différentes, la formule contient $\frac{n(n-1)}{2}$ variables.

\subsection*{Q38.}
La taille de la formule de \verb|gen_formule_n_dames| est
\begin{align*}
    C_n &= C_{ligne}(n) + C_{col}(n) + C_{diag}(n) + \Theta(1)\\
    &= nE_x(n) + nE_p(n) + 2\sum_{i=-n+2}^{n-2}E_p(|n-i|) + \Theta(n)\\
\end{align*}

Avec $E_x$ la fonction \verb|exactement_une| et $E_p$ \verb|au_plus_une|.

Or $nE_x(n) = \Theta(n^3)$, $nE_p(n) = \Theta(n^3)$ et
$2\sum_{i=-n+2}^{n-2}E_p(|n-i|) \leq 4nE_p(n) = O(n^3)$, donc

\begin{align*}
    C_n &= \Theta(n^3) + \Theta(n^3) + O(n^3) +\Theta(n)\\
    C_n &= \boxed{O(n^3)}\\
\end{align*}

\subsection*{Q40.}
Pour le problème à 5 dames, on obtient

\begin{lstlisting}
fred@mp2:~/DM3$ problemes/n_dames 5
Fichier '5_dames.txt' généré.
Taille du fichier : 3471 octets.
fred@mp2:~/DM3$ satsolver/fnc_solver '5_dames.txt'
La formule est sous FNC.
La formule est satisfiable en assignant 1 aux variables suivantes et 0 aux autres :
X_0_4
X_1_2
X_2_0
X_3_3
X_4_1
Temps d'exécution : 0.001377 s
\end{lstlisting}

Soit encore
\begin{center}
    \begin{tabular}{| c || *{5}{c |}}
    \hline
      & 0 & 1 & 2 & 3 & 4 \\
    \hline
    \hline
    0 &   &   & X &   &   \\
    \hline
    1 &   &   &   &   & X \\
    \hline
    2 &   & X &   &   &   \\
    \hline
    3 &   &   &   & X &   \\
    \hline
    4 & X &   &   &   &   \\
    \hline
    \end{tabular}
\end{center}

Pour le problème à 8 dames, on obtient
\begin{lstlisting}
fred@mp2:~/DM3$ satsolver/fnc_solver '8_dames.txt'
La formule est sous FNC.
La formule est satisfiable en assignant 1 aux variables suivantes et 0 aux autres :
X_0_7
X_1_3
X_2_0
X_3_2
X_6_6
X_5_1
X_4_5
X_7_4
Temps d'exécution : 0.005287 s
\end{lstlisting}

Soit encore
\begin{center}
    \begin{tabular}{| c || *{8}{c |}}
    \hline
      & 0 & 1 & 2 & 3 & 4 & 5 & 6 & 7 \\
    \hline
    \hline
    0 &   &   & X &   &   &   &   &   \\
    \hline
    1 &   &   &   &   &   & X &   &   \\
    \hline
    2 &   &   &   & X &   &   &   &   \\
    \hline
    3 &   & X &   &   &   &   &   &   \\
    \hline
    4 &   &   &   &   &   &   &   & X \\
    \hline
    5 &   &   &   &   & X &   &   &   \\
    \hline
    6 &   &   &   &   &   &   & X &   \\
    \hline
    7 & X &   &   &   &   &   &   &   \\
    \hline
    \end{tabular}
\end{center}

Et pour le problème à 3 dames, on obtient
\begin{lstlisting}
fred@mp2:~/DM3$ satsolver/fnc_solver '3_dames.txt'
La formule est sous FNC.
La formule est insatisfiable.
Temps d'exécution : 0.000985 s
\end{lstlisting}


\section{Problème des cinq maisons}
\subsection{Description}
Le problème des cinq maisons a les contraintes suivantes~:
\begin{enumerate}
    \item $\varphi_1$~: Chaque caractéristique («~anglais~», «~poisson
        rouge~», …) se retrouve dans exactement une des cinq maisons
    \item $\varphi_2$~: Chaque maison doit avoir exactement une caractéristique de chaque
        catégorie (nationalité, boisson, couleur, …). Par exemple, la maison
        1 doit avoir exactement une couleur.
    \item $\varphi_3$~: Contraintes de l’énoncé
\end{enumerate}

\subsection{Nomenclature}
Les variables utilisées dans les formules sont de la forme
\verb|numéro_caractéristique|. Par exemple~:
\begin{itemize}
    \item \verb|1_anglais| représente «~l’anglais habite dans la maison
        1~»
    \item \verb|5_poisson_rouge| représente «~la personne habitant la
        maison 5 a pour animal de compagnie un poisson rouge~»
    \item \verb|3_yop| représente «~la personne habitant la maison 3
        boit du yop~»
    \item etc.
\end{itemize}

Dans la suite de cette section, notons $C$ l’ensemble des caractéristiques
($C = \{\text{anglais}, \text{lait}, \text{escalade}, \dots\}$), $\mathscr C$
l’ensemble des catéogries de caractéristiques (nationalité, couleur, …) (donc
$C = \bigsqcup_{\mathcal C \in \mathscr C} \mathcal C$)
et utilisons
des indices de maison dans $[\![1, 5]\!]$.

\subsection{Modélisation de la contrainte 1}
Pour modéliser la contrainte «~Chaque caractéristique se retrouve dans
exactement une des cinq maisons~», on peut d’abord modéliser la contrainte
«~La caractéristique $c$ se retrouve dans exactement une maison~»,
en utilisant la formule suivante~:

\begin{equation*}
    \bigvee_{j = 1}^5 \left(\verb|j_c| \wedge \bigwedge_{\substack{i=1 \\ i \ne j}}^5 \neg \verb|i_c| \right)
\end{equation*}

(i.e. «~Soit cette caractéristique est dans la maison 1 et aucune autre,
soit dans la 2 et aucune autre, etc.~»)

Ainsi, on peut modéliser la contrainte sur toutes les caractéristiques en
faisant un «~et~» logique~:

\begin{equation*}
    \varphi_1 \equiv \bigwedge_{c\in C}\bigvee_{j = 1}^5 \left(\verb|j_c| \wedge \bigwedge_{\substack{i=1 \\ i \ne j}}^5 \neg \verb|i_c| \right)
\end{equation*}

\subsection{Modélisation de la contrainte 2}
Pour modéliser la contrainte «~Chaque maison doit avoir exactement une
caractéristique de chaque catégorie~», on peut d’abord modéliser la contrainte
«~La maison $i$ a exactement une caractéristique de la catégorie
$\mathcal C \in \mathscr C$~», en utilisant la formule suivante~:

\begin{equation*}
    \bigvee_{c'\in\mathcal C} \left(\verb|i_c'| \wedge \bigwedge_{\substack{c\in\mathcal C \\ c \ne c'}} \neg \verb|i_c| \right)
\end{equation*}

On peut alors modéliser la contrainte sur toutes les catégories de
caractéristiques avec un «~et~» logique~:

\begin{equation*}
    \bigwedge_{\mathcal C \in \mathscr C} \bigvee_{c'\in\mathcal C} \left(\verb|i_c'| \wedge \bigwedge_{\substack{c\in\mathcal C \\ c \ne c'}} \neg \verb|i_c| \right)
\end{equation*}

Et de même, on modélise la contrainte sur toutes les maisons ainsi~:

\begin{equation*}
    \varphi_2 \equiv \bigwedge_{i=1}^5 \bigwedge_{\mathcal C \in \mathscr C}\bigvee_{c'\in\mathcal C} \left(\verb|i_c'| \wedge \bigwedge_{\substack{c\in\mathcal C \\ c \ne c'}} \neg \verb|i_c| \right)
\end{equation*}

\subsection{Modélisation de la contrainte 3}
Les contraintes de l’énoncé se modélisent assez facilement. Par exemple,
«~L’Anglais vit dans une maison rouge~» se modélise ainsi~:

\begin{equation*}
    \bigvee_{i=1}^5 \verb|i_anglais| \wedge \verb|i_rouge|
\end{equation*}

«~La personne qui fait de l’escalade vit à côté de celle qui a des chats~» se
modélise avec cette formule~:
\begin{equation*}
    \left(\bigvee_{i=1}^4 \verb|i_escalade| \wedge \verb|(i+1)_chats|\right) \vee
    \left(\bigvee_{i=1}^4 \verb|i_chats| \wedge \verb|(i+1)_escalade|\right)
\end{equation*}

Encore plus simple, «~La personne qui vit dans la maison du centre boit du
lait~» se modélise avec la formule suivante~:
\begin{equation*}
    \verb|3_lait|
\end{equation*}

Il suffit ensuite de faire un «~et~» logique sur toutes les formules données
par les contraintes pour obtenir $\varphi_3$.

\subsection{Solution}
Le satsolver résoud le problème en 0.4 secondes. À noter que l’ordre des
contraintes est important~: écrire dans le fichier
$\varphi_1 \wedge \varphi_2 \wedge \varphi_3$ prend au moins 10 minutes
(peut-être beaucoup plus, on l’a arrêté avant), tandis que
$\varphi_3 \wedge \varphi_2 \wedge \varphi_1$ est beaucoup plus rapide.

La solution est la suivante~:
\begin{center}
\begin{tabular}{|c|c|c|c|c|c|}
    \hline
    Maison      & 1         & 2         & 3       & 4             & 5 \\
    \hline
    Couleur     & Jaune     & Bleu      & Rouge   & Vert          & Blanc \\
    \hline
    Nationalité & Norvégien & Danois    & Anglais & Allemand      & Suédois \\
    \hline
    Animal      & Chats     & Cheval    & Oiseaux & Poisson rouge & Chiens \\
    \hline
    Boisson     & Eau       & Thé       & Lait    & Café          & Yop \\
    \hline
    Sport       & Danse     & Escalade  & Vélo    & Karaté        & Basket \\
    \hline
\end{tabular}
\end{center}

Ainsi, le poisson rouge est l’animal de compagnie de l’Allemand.


\section{Problème du calendrier}
\subsection*{Description}
Pour la résolution du problème du calendrier, il faut respecter ces deux
règles~:
\begin{enumerate}
    \item Chaque case a une pièce (voire 0 pour certaines cases).
    \item Chaque pièce n'est utilisée qu'une seule fois.
\end{enumerate}

Pour représenter le problème, chaque case aura 10 variables,
indiquant si la pièce correspondante est dessus.

Elle seront de la forme \verb|X_0_0| avec $X$ le nom de la pièce, $(0,0)$ les
coordonnées de la case.
Exemples~: \verb|l_4_5|, \verb|T_2_7|. (Les noms des pièces sont I, L, S, b, C,
l, s, Z, T et V)

Pour optimiser, les cases qui doivent avoir 0 pièce ne seront pas créées ni
utilisées.

\subsubsection*{1. Contrainte sur une case}
Pour $p_{i,j}$ les variables «~p est en (i,j)~» et $\bb{P}$ l'ensembles des
pièces, la contrainte sur la case $(i,j)$ est
\begin{equation*}
    F_{i,j} = \left(\bigvee_{p\in\bb{P}} p_{i,j} \right) \land
    \bigwedge_{\substack{(p,p')\in\bb{P}^2\\p<p'}}\left(\lnot p_{i,j} \lor \lnot p'_{i,j}\right)
\end{equation*}
Cette formule est sous FNC.

\subsubsection*{2. Contrainte de toutes les cases}
Pour $C \subset [\![0,7]\!]^2$ l'ensemble des cases qui doivent être remplies,
la contrainte sur toutes les cases est
\begin{equation*}
    F = \bigwedge_{(i,j)\in C} \left(\left(\bigvee_{p\in\bb{P}} p_{i,j} \right) \land
        \bigwedge_{\substack{(p,p')\in\bb{P}^2\\p<p'}}\left(\lnot p_{i,j} \lor \lnot p'_{i,j}\right)\right)
\end{equation*}
Cette formule est sous FNC.

\subsubsection*{3. Contrainte sur une pièce}
Pour $\bb{V}_p$ l'ensemble des positions valides de la pièce $p$~:
\begin{equation*}
    N_v(p_{i,j}) = \begin{cases}
        p_{i,j} & \text{si $p$ dans la position $v$ est sur la case $(i,j)$}\\
        \lnot p_{i,j} & \text{sinon}
    \end{cases}
\end{equation*}

Exemple pour la pièce $T$ de position $v =
    \begin{pmatrix}
        0 & 0 & 1 & 0 \\
        1 & 1 & 1 & 0 \\
        0 & 0 & 1 & 0 \\
        0 & 0 & 0 & 0 \\
    \end{pmatrix}$

On a $N_v(T_{1,2}) = T_{1,2}$ et $N_v(T_{3,1}) = \lnot T_{3,1}$

La contrainte sur une pièce $p$ est
\begin{equation*}
    F_p = \bigvee_{v\in\bb{V}_p} \left( \bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right)
\end{equation*}

Mais cette formule n'est pas sous FNC, on doit passer par des variables
intermédiaires que l'on nomme $Z_{p,v}$.
\begin{align*}
    F_p &= \bigvee_{v\in\bb{V}_p} \left( \bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right)\\
    &= \left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right)
        \land \bigwedge_{v\in\bb{V}_p} \left(Z_{p,v} \leftrightarrow \bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right)\\
    &= \left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right)
        \land \bigwedge_{v\in\bb{V}_p} \left(Z_{p,v} \to \bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right){}
        \land \bigwedge_{v\in\bb{V}_p} \left(\lnot Z_{p,v} \to \lnot\bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right)\\
\end{align*}

Que l'on peut simplifier en
\begin{align*}
    F_p &= \left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right)
        \land \bigwedge_{v\in\bb{V}_p} \left(Z_{p,v} \to \bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right)\\
    &= \left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right)
        \land \bigwedge_{v\in\bb{V}_p} \left(\lnot Z_{p,v} \lor \bigwedge_{(i,j)\in C} N_v(p_{i,j}) \right)\\
    &= \left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right)
        \land \bigwedge_{\substack{(i,j)\in C\\v\in\bb{V}_p}} \left(\lnot Z_{p,v} \lor N_v(p_{i,j}) \right)\\
\end{align*}
qui est sous FNC.

\subsubsection*{4. Contrainte de toutes les pièces}
La contrainte sur toutes les pièces est
\begin{equation*}
    F = \bigwedge_{p\in\bb{P}} \left(\left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right) \land
        \bigwedge_{\substack{(i,j)\in C\\v\in\bb{V}_p}} \left(\lnot Z_{p,v} \lor N_v(p_{i,j}) \right)\right)
\end{equation*}
Cette formule est sous FNC.

\subsubsection*{5. Formule générale}
La formule générale est donc
\begin{equation*}
F = \bigwedge_{(i,j)\in C} \left(\left(\bigvee_{p\in\bb{P}} p_{i,j} \right) \land
    \bigwedge_{\substack{(p,p')\in\bb{P}^2\\p<p'}}\left(\lnot p_{i,j} \lor \lnot p'_{i,j}\right)\right) \land
    \bigwedge_{p\in\bb{P}} \left(\left( \bigvee_{v\in\bb{V}_p} Z_{p,v} \right) \land
    \bigwedge_{\substack{(i,j)\in C\\v\in\bb{V}_p}} \left(\lnot Z_{p,v} \lor N_v(p_{i,j}) \right)\right)
\end{equation*}

\subsection*{Implémentation}

\end{document}
